
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>帐号设置</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="fly,layui,前端社区">
  <meta name="description" content="Fly社区是模块化前端UI框架Layui的官网社区，致力于为web开发提供强劲动力">
  <link rel="stylesheet" href="../../layui/css/layui.css">
  <link rel="stylesheet" href="../../css/global.css">
</head>
<body>

<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo" href="/">
      <img src="../../images/logo.png" alt="layui">
    </a>
    
    <ul class="layui-nav fly-nav-user">
      <!-- 登入后的状态 -->
      <li class="layui-nav-item">
        <a class="fly-nav-avatar" href="javascript:;">
          <cite class="layui-hide-xs"></cite>
          <img src="../../images/head.png">
        </a>
        <dl class="layui-nav-child">
          <dd><a href="/to/index"><i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页</a></dd>
          <dd><a href="/to/set"><i class="layui-icon">&#xe620;</i>账号管理</a></dd>
          <hr style="margin: 5px 0;">
          <dd><a href="" style="text-align: center;" id="loginOut">退出登录</a></dd>
        </dl>
      </li>
    </ul>
  </div>
</div>

<div class="layui-container fly-marginTop fly-user-main">
  <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="user">
    <li class="layui-nav-item">
      <a href="/to/index">
        <i class="layui-icon">&#xe609;</i>
        我的课程
      </a>
    </li>
    <li class="layui-nav-item layui-this">
      <a href="/to/set">
        <i class="layui-icon">&#xe620;</i>
        基本设置
      </a>
    </li>
  </ul>

  <div class="site-tree-mobile layui-hide">
    <i class="layui-icon">&#xe602;</i>
  </div>
  <div class="site-mobile-shade"></div>
  
  <div class="site-tree-mobile layui-hide">
    <i class="layui-icon">&#xe602;</i>
  </div>
  <div class="site-mobile-shade"></div>
  
  
  <div class="fly-panel fly-panel-user" pad20>
    <div class="layui-tab layui-tab-brief" lay-filter="user">
      <ul class="layui-tab-title" id="LAY_mine">
        <li class="layui-this" lay-id="info">我的资料</li>
        <li lay-id="pass">密码</li>
      </ul>
      <div class="layui-tab-content" style="padding: 20px 0;">
        <div class="layui-form layui-form-pane layui-tab-item layui-show">
          <form method="post">
            <div class="layui-form-item">
              <label for="name" class="layui-form-label">姓名</label>
              <div class="layui-input-inline">
                <input type="text" id="name" name="name" required autocomplete="off" value="姚鑫" class="layui-input" disabled>
              </div>
            </div>
            <div class="layui-form-item">
              <label for="idcardno" class="layui-form-label">学号</label>
              <div class="layui-input-inline">
                <input type="text" id="idcardno" name="idcardno" required  autocomplete="off" value="41701013" class="layui-input" disabled>
              </div>
            </div>
            <div class="layui-form-item">
              <label for="classname" class="layui-form-label">班级</label>
              <div class="layui-input-inline">
                <input type="text" id="classname" name="classname" required lay-verify="required" autocomplete="off" value="2017级本计算机01班" class="layui-input" disabled>
              </div>
            </div>
            <div class="layui-form-item">
              <label for="phone" class="layui-form-label">电话</label>
              <div class="layui-input-inline">
                <input type="text" id="phone" name="phone" autocomplete="off" value="19981247617" class="layui-input">
              </div>
            </div>
            <div class="layui-form-item">
              <button class="layui-btn" key="set-mine" lay-filter="detail_sub" lay-submit>确认修改</button>
            </div>
        </form>
        </div>

          <div class="layui-form layui-form-pane layui-tab-item">
            <form action="/user/repass" method="post">
              <div class="layui-form-item">
                <label for="L_nowpass" class="layui-form-label">当前密码</label>
                <div class="layui-input-inline">
                  <input type="password" id="L_nowpass" name="nowpass" required lay-verify="required" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-form-item">
                <label for="L_pass" class="layui-form-label">新密码</label>
                <div class="layui-input-inline">
                  <input type="password" id="L_pass" name="pass" required lay-verify="required" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid layui-word-aux">6到16个字符</div>
              </div>
              <div class="layui-form-item">
                <label for="L_repass" class="layui-form-label">确认密码</label>
                <div class="layui-input-inline">
                  <input type="password" id="L_repass" name="repass" required lay-verify="required" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-form-item">
                <button class="layui-btn" key="set-mine" lay-filter="psw_sub" lay-submit>确认修改</button>
              </div>
            </form>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>

<div class="fly-footer">
  <p><a href="http://fly.layui.com/" target="_blank">Fly社区</a> 2017 &copy; <a href="http://www.layui.com/" target="_blank">layui.com 出品</a></p>
  <p>
    <a href="http://fly.layui.com/jie/3147/" target="_blank">付费计划</a>
    <a href="http://www.layui.com/template/fly/" target="_blank">获取Fly社区模版</a>
    <a href="http://fly.layui.com/jie/2461/" target="_blank">微信公众号</a>
  </p>
</div>

<script src="../../layui/layui.js"></script>
<script src="/js/check_token.js"></script>
<script>
  <!--这里是放置js代码区域-->
  layui.use(['element', 'layer', 'jquery','form'], function () {
    //form模块
    var form = layui.form;
    form.render(); //更新全部
    var element = layui.element;
    var $ = layui.$;
    //element模块
    $('.site-demo-active').on('click', function(){
      var othis = $(this), type = othis.data('type');
      active[type] ? active[type].call(this, othis) : '';
    });
    //Hash地址的定位
    var layid = location.hash.replace(/^#test=/, '');
    element.tabChange('test', layid);
    element.on('tab(test)', function(elem){
      location.hash = 'test='+ $(this).attr('lay-id');
    });

    //我的资料查询：UserController层中的getUser方法
    $(function () {
      var token = getCookies("Authorization");
      $.ajax({
        url: '/onlinets/user-info/getUser',
        type: 'GET',
        // 允许请求携带cookie
        xhrFields: {withCredentials: true}, //开启请求头
        headers: {Authorization: token},
        success: function (res) {
          if (res.code === 100) {
            var user = res.info.one_user; //接收到UserController中getUser方法中的one_user数据
            $('#name').append(user.name);
            $('#idcardno').val(user.idcardno);
            $('#classname').val(user.classname);
            $('#phone').val(user.phone);
            form.render('radio');
          }
        }
      });
    });

    //密码修改监听提交
    form.on('submit(psw_sub)', function(data){
      var token = getCookies("Authorization");
      var nowPsw = $('#L_nowpass').val();
      var newPsw = $('#L_pass').val();
      var renewPsw = $('#L_repass').val();
      if (nowPsw === newPsw){
        alert("新旧密码不能相同！");
      }else if (newPsw === renewPsw){
        $.ajax({
          url: '/onlinets/user-info/updatePsw/' + nowPsw + "/" + newPsw,
          type: 'PUT',
          xhrFields: {withCredentials: true},
          headers: {Authorization: token},
          syntax:false,
          success:function (res) {
            console.log(res);
            if (res.code === 100){
              alert("修改密码成功，请重新登录！");
              window.location.href="/to/login";
            }else {
              alert("修改密码失败，请重新修改！");
              window.location.href="/to/set";
              console.log("修改失败");
            }
          }
        });
      }else {
        alert("两次密码不正确！");
      }
      return false;
    });

    //我的资料修改监听提交
    form.on('submit(detail_sub)', function(data){
      var token = getCookies("Authorization");
      var user = new Object();
      user.phone= $('#phone').val();
      let u = JSON.stringify(user);
      console.log("前端u的信息"+u);
      if (phone === null){
        console.log("手机号为空");
        alert("手机号不能为空");
      }else {
        $.ajax({
          url: '/onlinets/user-info/updateMsg/' + u ,
          type: 'PUT',
          dataType: 'json',
          xhrFields: {withCredentials: true},
          headers: {Authorization: token},
          syntax:false,
          success:function (res) {
            console.log(res);
            if (res.code === 100){
              alert("资料修改成功！");
              window.location.href="/to/set";
            }else {
              alert("资料修改失败，请重新修改！");
              window.location.href="/to/set";
            }
          }
        });

      }
      return false;
    });
    $("#loginOut").on("click", function () {
      document.cookie = "UserAuthorization" + "=" + "";
      layer.msg("成功退出登录！", {
        time: 2000,
        end: function () {
          location.reload();
        }
      });

    });

  });
</script>

</body>
</html>